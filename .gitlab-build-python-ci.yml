image: python:3.10

.phx-job:
  cache:
    key: phx  # Use a unique key for each branch or tag
    paths:
      - phx
  tags:
    - ml-code
  only:
    - main


do_build:
  extends: .phx-job
  stage: build
  script:
    - py -m venv phx || true
    - source phx/bin/activate
    - echo "$CI_SERVER_URL is the url"
    - pip install wheel
    - pip install -r requirements.txt
    - python setup.py sdist bdist_wheel
    - pip install .
  artifacts:
    paths:
      - dist/

do_deploy:
  stage: deploy
  extends: .phx-job
  script:
    - pip install twine
    - twine upload dist/* --repository-url $CI_SERVER_URL/projects/$CI_PROJECT_ID/packages/pypi --username $PACKAGE_REGISTRY_USERNAME --password $PACKAGE_REGISTRY_PASSWORD
